---
title: "Project"
author: "Jiancong Qi, Zheng Wang, Janice Li, Joy Wang, Wenxin Zhou"
date: "2/19/2020"
output: html_document
---

```{r, message=FALSE}
library(readxl)
library(dplyr)
library(caret)
library(e1071)
library(corrplot)
library(ggplot2)
library(readr)
library(nlme)
```

### Data Cleaning
```{r, message=FALSE}
persian.UCLA = read_xlsx("PersianVCaucasianEyes.xlsx", sheet = 1)[,2:12]
persian.UCLA = na.omit(persian.UCLA)
persian.UCLA$Ethnicity = "Persian"

caucasian = read_xlsx("PersianVCaucasianEyes.xlsx", sheet = 2)[,2:12]
caucasian = na.omit(caucasian)

alldata = rbind(persian.UCLA, caucasian)

persian = read_xlsx("PersianVCaucasianEyes.xlsx", sheet = 3)[,2:9]
persian$Age = as.numeric(alldata %>% filter(Ethnicity == "Persian" & Sex == "M") %>% summarise(Age = median(Age)))
persian$Ethnicity = "Persian"

newAll = rbind(alldata[,c(11,2,5:10,1)], persian)
newTwo = alldata[,c(11,2,5:10,1)]

write.csv(newAll, file="full_data.csv")

newTwo$Ethnicity = as.factor(newTwo$Ethnicity)
newAll$Ethnicity = as.factor(newAll$Ethnicity)
persian$Ethnicity = as.factor(persian$Ethnicity)
```

###Exploratory Data Analysis


####Correlation of eye features
```{r, message=FALSE}
# All Data
corrplot(cor(newAll[,3:8]))

# Caucasian
corrplot(cor(newAll[which(newAll$Ethnicity=="Caucasian"),3:8]))

# Persian
corrplot(cor(newAll[which(newAll$Ethnicity=="Persian"),3:8]))
```

#####Observation:
1. MRD, PTB and TPS all show fairly high correlation between left and right eyes(0.8).
2. TPS and PTB correlate with each other(0.6). This correlation is slightly higher among Caucasian.
3. MRD has weak correlation with both PTB and TPS in Persian, but some relationships is minimal among Caucasian.


####Distribution of each eye feature
```{r}
ggplot(newAll, aes(x=`MRD-1 (L)`, fill=Ethnicity)) + geom_density(alpha=.3)+ theme_classic()
ggplot(newAll, aes(x=`MRD-1(R)`, fill=Ethnicity)) + geom_density(alpha=.3)+ theme_classic()
ggplot(newAll, aes(x=`PTB (L)`, fill=Ethnicity)) + geom_density(alpha=.3)+ theme_classic()
ggplot(newAll, aes(x=`PTB (R)`, fill=Ethnicity)) + geom_density(alpha=.3)+ theme_classic()
ggplot(newAll, aes(x=`TPS (L)`, fill=Ethnicity)) + geom_density(alpha=.3)+ theme_classic()
ggplot(newAll, aes(x=`TPS (R)`, fill=Ethnicity)) + geom_density(alpha=.3)+ theme_classic()
```

#####Observation:
1. MRD shows Gaussian distribution, while TPS seems lognormal. PTB is ambiguous and may be either.
2. Caucasian and Persian have obviously different MRD on both left and right eyes.


###Data Modeling to Predict Ethnicity
```{r, message=FALSE}

m1 = glm(Ethnicity ~ `MRD-1 (L)` + `MRD-1(R)` + `PTB (R)` + `TPS (R)` + `TPS (L)` + `PTB (L)`, data = newAll, family = "binomial")

m2 = glm(Ethnicity ~ `MRD-1 (L)` + `TPS (L)` + `PTB (L)`, data = newAll, family = "binomial")

m3 = glm(Ethnicity ~ `MRD-1 (L)` * `MRD-1(R)` * `PTB (R)` * `TPS (R)` * `TPS (L)` * `PTB (L)`, data = newAll
, family = "binomial")

m4 = glm(Ethnicity ~ `MRD-1 (L)` * `MRD-1(R)` * `PTB (R)` * log(`TPS (R)`) * log(`TPS (L)`) * `PTB (L)`, data = newAll, family = "binomial")


m5 = glm(Ethnicity ~ `MRD-1 (L)` + `MRD-1(R)` + `PTB (R)` + `TPS (R)` + `TPS (L)` + `PTB (L)`, data = newTwo, family = "binomial")

m6 = glm(Ethnicity ~ `MRD-1 (L)` + `TPS (L)` + `PTB (L)`, data = newTwo, family = "binomial")

m7 = glm(Ethnicity ~ `MRD-1 (L)` * `MRD-1(R)` * `PTB (R)` * `TPS (R)` * `TPS (L)` * `PTB (L)`, data = newTwo
, family = "binomial")

m8 = glm(Ethnicity ~ `MRD-1 (L)` * `MRD-1(R)` * `PTB (R)` * log(`TPS (R)`) * log(`TPS (L)`) * `PTB (L)`, data = newTwo
, family = "binomial")


summary(m1)

summary(m2)

summary(m3)

summary(m4)

summary(m5)

summary(m6)

summary(m7)


confusionMatrix(table(predict(m1,newAll[,1:8],type = 'response') >=0.5,newAll$Ethnicity=="Persian"))

confusionMatrix(table(predict(m2,newAll[,1:8],type = 'response') >=0.5,newAll$Ethnicity=="Persian"))

confusionMatrix(table(predict(m3,newAll[,1:8],type = 'response') >=0.5,newAll$Ethnicity=="Persian"))

confusionMatrix(table(predict(m4,newAll[,1:8],type = 'response') >=0.5,newAll$Ethnicity=="Persian"))

confusionMatrix(table(predict(m5,newAll[,1:8],type = 'response') >=0.5,newAll$Ethnicity=="Persian"))

confusionMatrix(table(predict(m6,newAll[,1:8],type = 'response') >=0.5,newAll$Ethnicity=="Persian"))

confusionMatrix(table(predict(m7,newAll[,1:8],type = 'response') >=0.5,newAll$Ethnicity=="Persian"))

confusionMatrix(table(predict(m8,newAll[,1:8],type = 'response') >=0.5,newAll$Ethnicity=="Persian"))


```
#####Observation:
m4 is the best since TPS has a Log-normal distribution.


```{r,message=FALSE, warning=FALSE, paged.print = FALSE}


random_effect_data <- read_csv("./random_effect_data.csv")

random_effect_MRD = lme(`MRD` ~ Ethnicity + Sex + Age, random_effect_data, random=~1|Person)
random_effect_PTB = lme(`PTB` ~ Ethnicity + Sex + Age, random_effect_data, random=~1|Person)
random_effect_TPS = lme(`TPS` ~ Ethnicity + Sex + Age, random_effect_data, random=~1|Person)


summary(random_effect_MRD)

summary(random_effect_PTB)

summary(random_effect_TPS)
```

